# .github/workflows/project-in-review.yml
name: "Project: Issue status on PR"

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
    branches:
      - "**"
  workflow_dispatch: {}

env:
  PROJECT_URL: https://github.com/orgs/Tiny-Clowns/projects/6/views/1

jobs:
  move_issue_status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
      checks: read
      repository-projects: write

    steps:
      - name: App token
        id: app
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: Tiny-Clowns

      - name: Resolve Project v2
        id: proj
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app.outputs.token }}
          script: |
            const m = (process.env.PROJECT_URL || "").match(/\/orgs\/([^/]+)\/projects\/(\d+)/i);
            if (!m) return core.setFailed("Bad PROJECT_URL");

            const owner = m[1];
            const number = parseInt(m[2], 10);

            const r = await github.graphql(
              `query($o:String!,$n:Int!){
                organization(login:$o){
                  projectV2(number:$n){
                    id
                    fields(first:50){
                      nodes{
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }`,
              { o: owner, n: number }
            );

            const p = r.organization?.projectV2;
            if (!p) return core.setFailed("Project not found");

            const status = (p.fields.nodes || []).find(f => f?.name === "Status");
            const inRev = status?.options.find(o => /in review/i.test(o.name));

            core.setOutput("projectId", p.id);
            core.setOutput("statusFieldId", status?.id || "");
            core.setOutput("inRevId", inRev?.id || "");

      - name: Move issue(s) from PR commits → In Review
        if: ${{ steps.proj.outputs.projectId != '' && steps.proj.outputs.statusFieldId != '' && steps.proj.outputs.inRevId != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app.outputs.token }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const projectId = "${{ steps.proj.outputs.projectId }}";
            const fieldId   = "${{ steps.proj.outputs.statusFieldId }}";
            const inRevId   = "${{ steps.proj.outputs.inRevId }}";

            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("No pull_request in context; nothing to do.");
              return;
            }

            // Skip promotion PRs: develop -> test, test -> main
            const base = (pr.base?.ref || "").toLowerCase();
            const head = (pr.head?.ref || "").toLowerCase();

            if (
              (head === "develop" && base === "test") ||
              (head === "test" && base === "main")
            ) {
              core.info(`Promotion PR ${head} -> ${base}, skip status update.`);
              return;
            }

            const targetStatusId = inRevId;
            if (!targetStatusId) {
              core.info("In Review status option ID is empty; check project Status options.");
              return;
            }

            const action = context.payload.action || "";
            core.info(`PR action='${action}', head='${head}', base='${base}' → set In Review.`);

            // Load all commits for this PR
            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              {
                owner,
                repo,
                pull_number: pr.number,
                per_page: 100
              }
            );

            const issueNumbers = new Set();

            // Extract #123 from commit messages
            for (const c of commits) {
              const msg = c.commit?.message || "";
              for (const m of msg.matchAll(/#(\d{1,7})/g)) {
                issueNumbers.add(parseInt(m[1], 10));
              }
            }

            if (issueNumbers.size === 0) {
              core.info("No #<issue> references found in PR commit messages.");
              return;
            }

            core.info(`Found issue references in commits: ${[...issueNumbers].join(", ")}`);

            for (const num of issueNumbers) {
              // Look up the issue node ID via GraphQL
              const res = await github.graphql(
                `query($o:String!,$r:String!,$n:Int!){
                  repository(owner:$o,name:$r){
                    issue(number:$n){ id }
                  }
                }`,
                { o: owner, r: repo, n: num }
              ).catch(() => null);

              const issueId = res?.repository?.issue?.id;
              if (!issueId) {
                core.warning(`Issue #${num} not found in ${owner}/${repo}`);
                continue;
              }

              // Add issue to project (no-op if already there), get project itemId
              const addRes = await github.graphql(
                `mutation($p:ID!,$c:ID!){
                  addProjectV2ItemById(input:{projectId:$p,contentId:$c}){
                    item{ id }
                  }
                }`,
                { p: projectId, c: issueId }
              ).catch(() => null);

              const itemId = addRes?.addProjectV2ItemById?.item?.id;
              if (!itemId) {
                core.warning(`Could not add issue #${num} to project`);
                continue;
              }

              // Update Status field for this project item to In Review
              await github.graphql(
                `mutation($p:ID!,$i:ID!,$f:ID!,$o:String!){
                  updateProjectV2ItemFieldValue(
                    input:{
                      projectId:$p,
                      itemId:$i,
                      fieldId:$f,
                      value:{ singleSelectOptionId:$o }
                    }
                  ){
                    clientMutationId
                  }
                }`,
                { p: projectId, i: itemId, f: fieldId, o: targetStatusId }
              ).catch(err => {
                core.warning(`Failed to set status for issue #${num}: ${err}`);
              });

              core.info(`Updated Status for issue #${num} → In Review.`);
            }
