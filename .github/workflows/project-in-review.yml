# .github/workflows/project-in-review.yml
name: "Project: In Review on PR"
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, edited]
    branches: ["**"]
  workflow_dispatch: {}

env:
  PROJECT_URL: https://github.com/orgs/Tiny-Clowns/projects/6/views/1

jobs:
  move_in_review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
      checks: read
      repository-projects: write
    steps:
      - name: App token
        id: app
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: Tiny-Clowns

      - name: Resolve Project v2
        id: proj
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app.outputs.token }}
          script: |
            const m = (process.env.PROJECT_URL||"").match(/\/orgs\/([^/]+)\/projects\/(\d+)/i);
            if (!m) return core.setFailed("Bad PROJECT_URL");
            const owner = m[1], number = parseInt(m[2],10);
            const r = await github.graphql(`query($o:String!,$n:Int!){
              organization(login:$o){ projectV2(number:$n){
                id
                fields(first:50){ nodes{ ... on ProjectV2SingleSelectField { id name options{ id name } } } }
              }}}`, { o: owner, n: number });
            const p = r.organization?.projectV2; if (!p) return core.setFailed("Project not found");
            const status = (p.fields.nodes||[]).find(f=>f?.name==="Status");
            const inRev = status?.options.find(o=>/in review/i.test(o.name));
            core.setOutput("projectId", p.id);
            core.setOutput("statusFieldId", status?.id||"");
            core.setOutput("inRevId", inRev?.id||"");

      - name: Move closing issues â†’ In Review
        if: ${{ steps.proj.outputs.projectId != '' && steps.proj.outputs.statusFieldId != '' && steps.proj.outputs.inRevId != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app.outputs.token }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const projectId = "${{ steps.proj.outputs.projectId }}";
            const fieldId   = "${{ steps.proj.outputs.statusFieldId }}";
            const inRevId   = "${{ steps.proj.outputs.inRevId }}";

            const issueIds = new Set();

            if (context.eventName === "pull_request") {
              const prNumber = context.payload.pull_request.number;
              const q = await github.graphql(`query($o:String!,$r:String!,$p:Int!){
                repository(owner:$o,name:$r){
                  pullRequest(number:$p){ closingIssuesReferences(first:50){ nodes{ id number } } }
                }
              }`, { o: owner, r: repo, p: prNumber });
              for (const n of q.repository.pullRequest.closingIssuesReferences.nodes) issueIds.add(n.id);
            } else {
              for (const c of (context.payload.commits || [])) {
                const msg = c.message || "";
                for (const m of msg.matchAll(/#(\d{1,7})/g)) {
                  const num = parseInt(m[1],10);
                  const r = await github.graphql(`query($o:String!,$r:String!,$n:Int!){
                    repository(owner:$o,name:$r){ issue(number:$n){ id } }
                  }`, { o: owner, r: repo, n: num }).catch(()=>null);
                  const id = r?.repository?.issue?.id; if (id) issueIds.add(id);
                }
              }
            }

            for (const id of issueIds) {
              const add = await github.graphql(`mutation($p:ID!,$c:ID!){
                addProjectV2ItemById(input:{projectId:$p,contentId:$c}){ item{ id } }
              }`, { p: projectId, c: id }).catch(()=>null);
              const itemId = add?.addProjectV2ItemById?.item?.id; if (!itemId) continue;

              await github.graphql(`mutation($p:ID!,$i:ID!,$f:ID!,$o:String!){
                updateProjectV2ItemFieldValue(input:{projectId:$p,itemId:$i,fieldId:$f,value:{singleSelectOptionId:$o}}){ clientMutationId }
              }`, { p: projectId, i: itemId, f: fieldId, o: inRevId });
            }
