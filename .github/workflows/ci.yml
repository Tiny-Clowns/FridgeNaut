name: ci

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend:
    name: .NET build/lint/test + vuln audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: project
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: dotnet format (verify)
        run: dotnet format --verify-no-changes

      - name: Build (warnings as errors)
        run: dotnet build FridgeNaut.sln -c Release -warnaserror

      - name: Test
        run: |
          if ls **/*.Tests.csproj >/dev/null 2>&1; then
            dotnet test FridgeNaut.sln -c Release --no-build
          else
            echo "No test projects found."
          fi

      - name: NuGet vulnerability audit
        run: |
          set -eo pipefail
          OUT="$(dotnet list FridgeNaut.sln package --vulnerable --include-transitive || true)"
          echo "$OUT"
          echo "$OUT" | grep -qi "vulnerab" && { echo "Vulnerable packages detected"; exit 1; } || echo "No known vulnerabilities."

  flutter:
    name: Flutter analyze/test + APK build check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: project/flutter-fridge-app
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platforms;android-34
            build-tools;34.0.0
            platform-tools

      - name: Pub get
        run: flutter pub get

      - name: Dart format check
        run: dart format --output none --set-exit-if-changed .

      - name: Analyze
        run: flutter analyze

      - name: Test
        run: flutter test

      - name: Build debug APK (verification only)
        run: flutter build apk --debug --no-shrink

  secrets:
    name: Secrets scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --report-format sarif --report-path gitleaks.sarif

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
