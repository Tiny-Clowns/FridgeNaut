# .github/workflows/project-in-progress-on-branch.yml
name: "Project: In Progress on branch"
on:
  create:
    branches: ["**"]
  push:
    branches: ["**"]
  workflow_dispatch: {}

env:
  PROJECT_URL: https://github.com/orgs/Tiny-Clowns/projects/6/views/1

jobs:
  move_in_progress:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
      checks: read
      repository-projects: write
    steps:
      - name: App token
        id: app
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: Tiny-Clowns

      - name: Resolve Project v2
        id: proj
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app.outputs.token }}
          script: |
            const m = (process.env.PROJECT_URL||"").match(/\/orgs\/([^/]+)\/projects\/(\d+)/i);
            if (!m) return core.setFailed("Bad PROJECT_URL");
            const owner = m[1], number = parseInt(m[2],10);
            const r = await github.graphql(`query($o:String!,$n:Int!){
              organization(login:$o){ projectV2(number:$n){
                id
                fields(first:50){ nodes{ ... on ProjectV2SingleSelectField { id name options{ id name } } } }
              }}}`, { o: owner, n: number });
            const p = r.organization?.projectV2; if (!p) return core.setFailed("Project not found");
            const status = (p.fields.nodes||[]).find(f=>f?.name==="Status");
            function opt(rx){ return status?.options.find(o=>rx.test(o.name))?.id || ""; }
            core.setOutput("projectId", p.id);
            core.setOutput("statusFieldId", status?.id||"");
            core.setOutput("inProgId", opt(/in progress/i));

      - name: Move issues → In Progress
        if: ${{ steps.proj.outputs.projectId != '' && steps.proj.outputs.statusFieldId != '' && steps.proj.outputs.inProgId != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app.outputs.token }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const projectId = "${{ steps.proj.outputs.projectId }}";
            const fieldId   = "${{ steps.proj.outputs.statusFieldId }}";
            const inProgId  = "${{ steps.proj.outputs.inProgId }}";

            function extractIssueNums(){
              const out = new Set();
              const ref = (context.payload.ref || context.ref || "").replace(/^refs\/heads\//,"");
              for (const m of ref.matchAll(/(?:^|[\/\-_#])(?:issue-)?(\d{1,7})(?=[\/\-_]|$)/ig)) out.add(parseInt(m[1],10));
              if (context.eventName === "push") {
                for (const c of (context.payload.commits || [])) {
                  const msg = c.message || "";
                  for (const m of msg.matchAll(/#(\d{1,7})/g)) out.add(parseInt(m[1],10));
                }
              }
              return [...out];
            }

            async function issueId(num){
              const q = await github.graphql(`query($o:String!,$r:String!,$n:Int!){
                repository(owner:$o,name:$r){ issue(number:$n){ id } }
              }`, { o: owner, r: repo, n: num }).catch(()=>null);
              return q?.repository?.issue?.id || null;
            }

            async function addItem(contentId){
              const a = await github.graphql(`mutation($p:ID!,$c:ID!){
                addProjectV2ItemById(input:{projectId:$p,contentId:$c}){ item{ id } }
              }`, { p: projectId, c: contentId }).catch(()=>null);
              return a?.addProjectV2ItemById?.item?.id || null;
            }

            async function currentStatus(itemId){
              const q = await github.graphql(`query($id:ID!){
                node(id:$id){
                  ... on ProjectV2Item {
                    fieldValues(first:50){ nodes{
                      ... on ProjectV2ItemFieldSingleSelectValue { name field{ ... on ProjectV2SingleSelectField { name id } } }
                    }}
                  }
                }
              }`, { id: itemId });
              const v = q?.node?.fieldValues?.nodes || [];
              return v.find(x => x.field?.name === "Status")?.name || null;
            }

            async function setStatus(itemId, optionId){
              await github.graphql(`mutation($p:ID!,$i:ID!,$f:ID!,$o:String!){
                updateProjectV2ItemFieldValue(input:{projectId:$p,itemId:$i,fieldId:$f,value:{singleSelectOptionId:$o}}){ clientMutationId }
              }`, { p: projectId, i: itemId, f: fieldId, o: optionId });
            }

            for (const n of extractIssueNums()) {
              const id = await issueId(n); if (!id) continue;
              const itemId = await addItem(id); if (!itemId) continue;
              const cur = await currentStatus(itemId);
              if (cur && !/^(todo|backlog)$/i.test(cur)) { core.info(`#${n} in '${cur}', skip`); continue; }
              await setStatus(itemId, inProgId);
              core.info(`#${n} → In Progress`);
            }
