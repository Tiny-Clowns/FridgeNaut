name: "Project: add new issues to Backlog"
on:
  issues:
    types: [opened]

jobs:
  add_and_backlog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
      repository-projects: write
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const projectNumber = 3;

            const proj = await github.graphql(`
              query($owner:String!, $number:Int!){
                user(login:$owner){
                  projectV2(number:$number){
                    id
                    fields(first:50){
                      nodes{
                        ... on ProjectV2SingleSelectField {
                          id name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }`, { owner, number: projectNumber });

            const project = proj.user.projectV2;
            const statusField = project.fields.nodes.find(f => f?.name === "Status");
            const backlog = statusField?.options.find(o => /backlog/i.test(o.name));
            if (!statusField || !backlog) {
              core.setFailed("Project Status 'Backlog' not found");
              return;
            }

            const issueNum = context.payload.issue.number;
            const issueQ = await github.graphql(`
              query($owner:String!, $repo:String!, $num:Int!){
                repository(owner:$owner, name:$repo){
                  issue(number:$num){ id }
                }
              }`, { owner, repo, num: issueNum });

            const issueId = issueQ.repository.issue.id;

            const add = await github.graphql(`
              mutation($projectId:ID!,$contentId:ID!){
                addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}) {
                  item { id }
                }
              }`, { projectId: project.id, contentId: issueId }).catch(() => null);
            const itemId = add?.addProjectV2ItemById?.item?.id;
            if (!itemId) { core.setFailed("Could not add issue to project"); return; }

            await github.graphql(`
              mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $optionId:String!){
                updateProjectV2ItemFieldValue(input:{
                  projectId:$projectId,
                  itemId:$itemId,
                  fieldId:$fieldId,
                  value:{ singleSelectOptionId:$optionId }
                }) { clientMutationId }
              }`, {
                projectId: project.id,
                itemId,
                fieldId: statusField.id,
                optionId: backlog.id
              });
