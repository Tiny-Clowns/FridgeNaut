# .github/workflows/project-add-backlog.yml
name: "Project: add new issues to Backlog"
on:
  issues:
    types: [opened]
  workflow_dispatch: {}

env:
  PROJECT_URL: https://github.com/orgs/Tiny-Clowns/projects/6/views/1

jobs:
  add_and_backlog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
      checks: read
      repository-projects: write
    steps:
      - name: Resolve Project v2
        id: proj
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const m = (process.env.PROJECT_URL||"").match(/\/orgs\/([^/]+)\/projects\/(\d+)/i);
            if (!m) return core.setFailed("Bad PROJECT_URL");
            const owner = m[1], number = parseInt(m[2],10);
            const r = await github.graphql(`query($o:String!,$n:Int!){
              organization(login:$o){
                projectV2(number:$n){
                  id
                  fields(first:50){ nodes{ ... on ProjectV2SingleSelectField { id name options{ id name } } } }
                }
              }}`, { o: owner, n: number });
            const p = r.organization?.projectV2; if (!p) return core.setFailed("Project not found");
            const status = (p.fields.nodes||[]).find(f=>f?.name==="Status");
            const backlog = status?.options.find(o=>/backlog/i.test(o.name));
            core.setOutput("projectId", p.id);
            core.setOutput("statusFieldId", status?.id||"");
            core.setOutput("backlogId", backlog?.id||"");

      - name: Add issue → Backlog
        if: ${{ steps.proj.outputs.projectId != '' && steps.proj.outputs.statusFieldId != '' && steps.proj.outputs.backlogId != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const issueNum = context.payload.issue.number;
            const projectId = "${{ steps.proj.outputs.projectId }}";
            const fieldId   = "${{ steps.proj.outputs.statusFieldId }}";
            const backlogId = "${{ steps.proj.outputs.backlogId }}";

            const iq = await github.graphql(`query($o:String!,$r:String!,$n:Int!){
              repository(owner:$o,name:$r){ issue(number:$n){ id } }
            }`, { o: owner, r: repo, n: issueNum });
            const issueId = iq.repository.issue.id;

            const add = await github.graphql(`mutation($p:ID!,$c:ID!){
              addProjectV2ItemById(input:{projectId:$p,contentId:$c}){ item{ id } }
            }`, { p: projectId, c: issueId }).catch(()=>null);
            const itemId = add?.addProjectV2ItemById?.item?.id; if (!itemId) core.setFailed("Could not add issue to project.");

            await github.graphql(`mutation($p:ID!,$i:ID!,$f:ID!,$o:String!){
              updateProjectV2ItemFieldValue(input:{projectId:$p,itemId:$i,fieldId:$f,value:{singleSelectOptionId:$o}}){ clientMutationId }
            }`, { p: projectId, i: itemId, f: fieldId, o: backlogId });
            core.info(`#${issueNum} → Backlog`);
